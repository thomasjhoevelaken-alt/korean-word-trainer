<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Korean Word Trainer</title>
  <style>
    body { font-family: sans-serif; max-width: 650px; margin: auto; padding: 20px; }
    input, button, select { padding: 8px; margin: 5px; }
    .card { border: 1px solid #ccc; padding: 20px; margin-top: 20px; text-align: center; cursor: pointer; }
    .word-list { margin-top: 20px; }
    .word-item { display: flex; flex-direction: column; margin: 8px 0; padding: 6px; border: 1px solid #eee; }
    .word-row { display: flex; justify-content: space-between; align-items: center; }
    .small-btn { font-size: 14px; padding: 4px 6px; }
    .danger { background: #f66; color: white; border: none; }
  </style>
</head>
<body>
  <h1>ğŸ‡°ğŸ‡· Korean Word Trainer</h1>

  <h3>Add a Word</h3>
  <input id="korean" placeholder="Korean word">
  <input id="english" placeholder="English meaning">
  <select id="category">
    <option value="">Category (optional)</option>
    <option value="verbs">Verbs</option>
    <option value="greetings">Greetings</option>
    <option value="food">Food</option>
    <option value="custom">Custom</option>
  </select>
  <button onclick="addWord()">Add</button>

  <h3>Search Words</h3>
  <input id="searchBox" placeholder="Search..." oninput="renderWordList()">

  <h3>Practice</h3>
  <button onclick="nextCard()">Next Word</button>
  <div id="card" class="card">Press "Next Word" to start</div>

  <h3>Your Words</h3>
  <div id="wordList" class="word-list"></div>

  <h3>Listening Mode</h3>
  <button onclick="playSelected()">â–¶ï¸ Play Selected</button>
  <button onclick="stopPlaying()">â¹ Stop</button>
  <label><input type="checkbox" id="repeatMode"> ğŸ” Repeat</label>
  <label><input type="number" id="delay" value="1000"> Delay (ms)</label>
  <div>
    <button onclick="setPlayMode('order')">Play in Order</button>
    <button onclick="setPlayMode('shuffle')">Shuffle</button>
  </div>
  <div>
    <label><input type="radio" name="langMode" value="both" checked> Korean + English</label>
    <label><input type="radio" name="langMode" value="korean"> Korean Only</label>
    <label><input type="radio" name="langMode" value="english"> English Only</label>
  </div>

  <script>
    let words = JSON.parse(localStorage.getItem("words")) || [];
    let current = null;
    let showingKorean = true;
    let mediaRecorder;
    let playing = false;
    let playMode = "order";

    function saveWords() {
      localStorage.setItem("words", JSON.stringify(words));
      renderWordList();
    }

    function addWord() {
      const k = document.getElementById("korean").value.trim();
      const e = document.getElementById("english").value.trim();
      const c = document.getElementById("category").value;
      if (k && e) {
        words.push({ korean: k, english: e, category: c, audioKorean: null, audioEnglish: null, selected: true });
        document.getElementById("korean").value = "";
        document.getElementById("english").value = "";
        saveWords();
      }
    }

    function deleteWord(i) {
      if (confirm('Delete "' + words[i].korean + ' - ' + words[i].english + '"?')) {
        words.splice(i, 1);
        saveWords();
      }
    }

    function editWord(i) {
      const k = prompt("Edit Korean word:", words[i].korean);
      const e = prompt("Edit English meaning:", words[i].english);
      if (k && e) {
        words[i].korean = k;
        words[i].english = e;
        saveWords();
      }
    }

    function renderWordList() {
      const search = document.getElementById("searchBox").value.toLowerCase();
      const list = document.getElementById("wordList");
      list.innerHTML = "";
      words
        .filter(w => w.korean.toLowerCase().includes(search) || w.english.toLowerCase().includes(search))
        .forEach((w, i) => {
        const div = document.createElement("div");
        div.className = "word-item";
        div.innerHTML = `
          <div class="word-row">
            <span>${w.korean} - ${w.english} (${w.category || "no category"})</span>
            <div>
              <input type="checkbox" ${w.selected ? "checked" : ""} onchange="toggleWord(${i}, this.checked)">
              <button class="small-btn" onclick="editWord(${i})">âœï¸</button>
              <button class="small-btn danger" onclick="deleteWord(${i})">ğŸ—‘</button>
            </div>
          </div>
          <div class="word-row">
            <button class="small-btn" onclick="recordAudio(${i}, 'korean')">ğŸ¤ Korean</button>
            <button class="small-btn" onclick="recordAudio(${i}, 'english')">ğŸ¤ English</button>
          </div>
        `;
        list.appendChild(div);
      });
    }

    function toggleWord(i, checked) {
      words[i].selected = checked;
      saveWords();
    }

    async function recordAudio(i, type) {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("Audio recording not supported in this browser.");
        return;
      }
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      let chunks = [];
      mediaRecorder.ondataavailable = e => chunks.push(e.data);
      mediaRecorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'audio/webm' });
        const url = URL.createObjectURL(blob);
        if (type === "korean") {
          words[i].audioKorean = url;
        } else {
          words[i].audioEnglish = url;
        }
        saveWords();
        alert(type + " recording saved!");
      };
      mediaRecorder.start();
      setTimeout(() => mediaRecorder.stop(), 3000);
    }

    function nextCard() {
      if (words.length === 0) {
        document.getElementById("card").innerText = "No words yet!";
        return;
      }
      current = words[Math.floor(Math.random() * words.length)];
      showingKorean = true;
      document.getElementById("card").innerText = current.korean;
      document.getElementById("card").onclick = flipCard;
    }

    function flipCard() {
      if (!current) return;
      document.getElementById("card").innerText = showingKorean ? current.english : current.korean;
      showingKorean = !showingKorean;
    }

    function setPlayMode(mode) {
      playMode = mode;
    }

    async function playSelected() {
      if (playing) return;
      playing = true;
      const repeat = document.getElementById("repeatMode").checked;
      const delay = parseInt(document.getElementById("delay").value) || 1000;
      const langMode = document.querySelector("input[name='langMode']:checked").value;

      do {
        let items = words.filter(w => w.selected && (w.audioKorean || w.audioEnglish));
        if (playMode === "shuffle") items = items.sort(() => Math.random() - 0.5);

        for (let w of items) {
          if (!playing) break;
          if (langMode !== "english" && w.audioKorean) {
            let audioK = new Audio(w.audioKorean);
            await audioK.play();
            await new Promise(res => audioK.onended = res);
            await new Promise(res => setTimeout(res, delay));
          }
          if (!playing) break;
          if (langMode !== "korean" && w.audioEnglish) {
            let audioE = new Audio(w.audioEnglish);
            await audioE.play();
            await new Promise(res => audioE.onended = res);
            await new Promise(res => setTimeout(res, delay));
          }
        }
      } while (playing && repeat);

      playing = false;
    }

    function stopPlaying() {
      playing = false;
    }

    renderWordList();
  </script>
</body>
</html>